let excludedReasons = ExternalData(reason: string)
  [@"<URL or Path to AzureExcludedReasons.csv>"];
let scannerIps = ExternalData(scanner_ip: string)
  [@"<URL or Path to axa_scanner_ips.csv>"];
let filteredEvents = Authentication 
  | where Action == "failure"
  | where User matches regex @".*\.aga.*|.*\.wka.*|.*\.wga.*|.*\.adm.*|.*\.dca.*|.*\.cya.*|.*\.esx.*|.*\.azm.*"
  | where User !in (excludedReasons)
  | where SrcIp !matches regex @".*tsp.*|.*tsd.*|.*LVMAPPPD1.*|.*cya.*"
  | where DestinationIp !matches regex @".*tsp.*|.*tsd.*|.*cya.*"
  | where SrcIp !in (scannerIps)
  | where Signature !contains "User name does not exist"
  | where SourceType !contains "crowdstrike"
  | where SignatureId !in (4776, 4771, 4768, 4769)
  | summarize 
      Count = count(), 
      SrcIps = make_set(SrcIp), 
      DestIps = make_set(DestinationIp), 
      Signatures = make_set(Signature), 
      SignatureIds = make_set(SignatureId), 
      SourceTypes = make_set(SourceType)
    by User, App, Reason, bin(TimeGenerated, 10m)
  | where Count > 10
  | project TimeGenerated, User, SrcIps, DestIps, App, SignatureIds, Signatures, Reason, SourceTypes, Count;
filteredEvents
